IF OBJECT_ID('tempdb.dbo.#Input', 'U') IS NOT NULL
BEGIN
	DROP TABLE #Input
END

IF OBJECT_ID('tempdb.dbo.#TileEdges', 'U') IS NOT NULL
BEGIN
	DROP TABLE #TileEdges
END

IF OBJECT_ID('tempdb.dbo.#TileGroups', 'U') IS NOT NULL
BEGIN
	DROP TABLE #TileGroups
END

IF OBJECT_ID('tempdb.dbo.#TileData', 'U') IS NOT NULL
BEGIN
	DROP TABLE #TileData
END

IF OBJECT_ID('tempdb.dbo.#AdjacentTiles', 'U') IS NOT NULL
BEGIN
	DROP TABLE #AdjacentTiles
END

CREATE TABLE #Input (
	InputRowId bigint not null IDENTITY(1,1),
	TileLine nvarchar(max)
)

--INSERT INTO #Input
--VALUES
--('Tile 2311:'),
--('..##.#..#.'),
--('##..#.....'),
--('#...##..#.'),
--('####.#...#'),
--('##.##.###.'),
--('##...#.###'),
--('.#.#.#..##'),
--('..#....#..'),
--('###...#.#.'),
--('..###..###'),
--(''),
--('Tile 1951:'),
--('#.##...##.'),
--('#.####...#'),
--('.....#..##'),
--('#...######'),
--('.##.#....#'),
--('.###.#####'),
--('###.##.##.'),
--('.###....#.'),
--('..#.#..#.#'),
--('#...##.#..'),
--(''),
--('Tile 1171:'),
--('####...##.'),
--('#..##.#..#'),
--('##.#..#.#.'),
--('.###.####.'),
--('..###.####'),
--('.##....##.'),
--('.#...####.'),
--('#.##.####.'),
--('####..#...'),
--('.....##...'),
--(''),
--('Tile 1427:'),
--('###.##.#..'),
--('.#..#.##..'),
--('.#.##.#..#'),
--('#.#.#.##.#'),
--('....#...##'),
--('...##..##.'),
--('...#.#####'),
--('.#.####.#.'),
--('..#..###.#'),
--('..##.#..#.'),
--(''),
--('Tile 1489:'),
--('##.#.#....'),
--('..##...#..'),
--('.##..##...'),
--('..#...#...'),
--('#####...#.'),
--('#..#.#.#.#'),
--('...#.#.#..'),
--('##.#...##.'),
--('..##.##.##'),
--('###.##.#..'),
--(''),
--('Tile 2473:'),
--('#....####.'),
--('#..#.##...'),
--('#.##..#...'),
--('######.#.#'),
--('.#...#.#.#'),
--('.#########'),
--('.###.#..#.'),
--('########.#'),
--('##...##.#.'),
--('..###.#.#.'),
--(''),
--('Tile 2971:'),
--('..#.#....#'),
--('#...###...'),
--('#.#.###...'),
--('##.##..#..'),
--('.#####..##'),
--('.#..####.#'),
--('#..#.#..#.'),
--('..####.###'),
--('..#.#.###.'),
--('...#.#.#.#'),
--(''),
--('Tile 2729:'),
--('...#.#.#.#'),
--('####.#....'),
--('..#.#.....'),
--('....#..#.#'),
--('.##..##.#.'),
--('.#.####...'),
--('####.#.#..'),
--('##.####...'),
--('##..#.##..'),
--('#.##...##.'),
--(''),
--('Tile 3079:'),
--('#.#.#####.'),
--('.#..######'),
--('..#.......'),
--('######....'),
--('####.#..#.'),
--('.#...#.##.'),
--('#.#####.##'),
--('..#.###...'),
--('..#.......'),
--('..#.###...');

INSERT INTO #Input
VALUES
('Tile 1559:'),
('.......#.#'),
('#.#.......'),
('#.#.......'),
('#.#.......'),
('..........'),
('#.#..#..#.'),
('...##..#.#'),
('..........'),
('#.#....##.'),
('..##......'),
(''),
('Tile 3253:'),
('##....####'),
('#......#..'),
('##.......#'),
('#..##.....'),
('#.........'),
('....#.....'),
('....#....#'),
('###.####.#'),
('#####...#.'),
('.#..#.#..#'),
(''),
('Tile 1307:'),
('......####'),
('.##.#....#'),
('##..#.....'),
('#.#..#..#.'),
('.#.#......'),
('#.##......'),
('..#......#'),
('###.#...##'),
('#..#....##'),
('.#.#..##.#'),
(''),
('Tile 2999:'),
('..#....#.#'),
('#...#.....'),
('#.#..#....'),
('........##'),
('#....#...#'),
('##.....#.#'),
('.##......#'),
('##..#....#'),
('......##.#'),
('#...#..###'),
(''),
('Tile 1847:'),
('..#...#.#.'),
('#..#.##.##'),
('..##.#...#'),
('.......###'),
('.......#.#'),
('##.##..#..'),
('.....##...'),
('#.....#..#'),
('#.#......#'),
('.#.##.####'),
(''),
('Tile 2731:'),
('#..#....##'),
('.....#...#'),
('#.........'),
('#...#.....'),
('.#....#..#'),
('....#.....'),
('#...##..#.'),
('##.....###'),
('#.........'),
('.#.##...##'),
(''),
('Tile 1453:'),
('.##..#.#..'),
('#.......#.'),
('.........#'),
('.........#'),
('..#.......'),
('......#...'),
('#####.#...'),
('...#.#...#'),
('..........'),
('#.#.###...'),
(''),
('Tile 1093:'),
('.###..####'),
('#.......##'),
('.....##..#'),
('....#....#'),
('#....#...#'),
('........##'),
('.....#....'),
('.....#....'),
('......#.#.'),
('.#....##..'),
(''),
('Tile 1913:'),
('.#..##....'),
('...##.....'),
('#.........'),
('#........#'),
('##....#..#'),
('#....#....'),
('.....##..#'),
('....#...#.'),
('#.#......#'),
('...#....#.'),
(''),
('Tile 3463:'),
('.##...#.#.'),
('#..##.....'),
('#.#.#.#...'),
('###...#..#'),
('...#.#..##'),
('#......###'),
('.##..##..#'),
('.#.##....#'),
('..#..##.##'),
('.....#..##'),
(''),
('Tile 3581:'),
('.######...'),
('##..#....#'),
('##...#..#.'),
('##........'),
('#.......#.'),
('.....#...#'),
('#.#.###...'),
('#....#...#'),
('###.......'),
('...##.#...'),
(''),
('Tile 3923:'),
('..##....##'),
('.#...#.#.#'),
('....#...#.'),
('......#...'),
('#........#'),
('#......##.'),
('....##...#'),
('#...#.....'),
('......##..'),
('#.###...#.'),
(''),
('Tile 3613:'),
('..#.#.....'),
('.........#'),
('..........'),
('##.......#'),
('#.#..#...#'),
('##.....#.#'),
('#...#.....'),
('.#..#.....'),
('........##'),
('###...###.'),
(''),
('Tile 3931:'),
('#..#......'),
('...##....#'),
('#...##..#.'),
('..#.......'),
('###...#..#'),
('##.....##.'),
('.##......#'),
('..........'),
('#.........'),
('###...##.#'),
(''),
('Tile 3407:'),
('###.#...##'),
('.##..#..#.'),
('#.#....#.#'),
('#.........'),
('#.........'),
('#.#......#'),
('.#....##..'),
('#..##....#'),
('#...##....'),
('.....#.#.#'),
(''),
('Tile 1823:'),
('###..#...#'),
('....#..#.#'),
('#........#'),
('..........'),
('......#.#.'),
('...#....#.'),
('###.......'),
('#.....#...'),
('#.###....#'),
('...######.'),
(''),
('Tile 1709:'),
('.#...#...#'),
('#........#'),
('#...#...##'),
('.#.......#'),
('.#....#..#'),
('#.#...###.'),
('....#.....'),
('#....#..#.'),
('#........#'),
('.#..#..#.#'),
(''),
('Tile 1097:'),
('#.#.#.#...'),
('#..#....##'),
('#..#......'),
('#..#......'),
('...#.#....'),
('..#......#'),
('.###.....#'),
('..#....#.#'),
('#...#.....'),
('...#.##.#.'),
(''),
('Tile 2339:'),
('....#..##.'),
('#......###'),
('##........'),
('.#......##'),
('..#......#'),
('#.#......#'),
('.#.#.....#'),
('...#......'),
('.##.#..#..'),
('#.###...#.'),
(''),
('Tile 2791:'),
('.##.#####.'),
('#.#...#..#'),
('....###..#'),
('#....#....'),
('.........#'),
('#..##..##.'),
('##.#.#.#..'),
('#.....#..#'),
('......####'),
('..#######.'),
(''),
('Tile 1637:'),
('#.##.#.##.'),
('###.....#.'),
('#..##.....'),
('.......##.'),
('#.......##'),
('......####'),
('#.#.#.....'),
('#.......#.'),
('#........#'),
('#..#...#..'),
(''),
('Tile 2843:'),
('####.#####'),
('.........#'),
('..........'),
('#.#.....#.'),
('.#.......#'),
('......##.#'),
('#....#...#'),
('..#.......'),
('...#......'),
('.#...####.'),
(''),
('Tile 1109:'),
('.###..#..#'),
('##.##.....'),
('...#......'),
('#........#'),
('.....##..#'),
('..#.#....#'),
('.#.#.#...#'),
('#.##......'),
('.#.#..#..#'),
('...#.#.#..'),
(''),
('Tile 3061:'),
('.#..#.#.#.'),
('##...###.#'),
('#..####...'),
('#....#.#.#'),
('......#..#'),
('..#.......'),
('#........#'),
('##.#.##..#'),
('.....##..#'),
('.#.##.##..'),
(''),
('Tile 3517:'),
('.....##.##'),
('#......#.#'),
('#.#..#..#.'),
('.........#'),
('#..##.....'),
('#......#.#'),
('.##.....##'),
('#.....#..#'),
('.#......#.'),
('..###.....'),
(''),
('Tile 3833:'),
('..##.####.'),
('#.........'),
('#...#.#..#'),
('#.........'),
('#.###....#'),
('#.....##.#'),
('...#....#.'),
('#....##.##'),
('#.#...#.##'),
('###.#.....'),
(''),
('Tile 1129:'),
('##.#......'),
('..#.....##'),
('##....##.#'),
('#....#...#'),
('..#.......'),
('...#.#....'),
('#........#'),
('...#.....#'),
('.........#'),
('.#..###..#'),
(''),
('Tile 1951:'),
('.#..##.###'),
('..####...#'),
('.####..#..'),
('....#...#.'),
('#...#.#...'),
('...##....#'),
('#........#'),
('......#.#.'),
('.........#'),
('.#.##...##'),
(''),
('Tile 2039:'),
('....#..#..'),
('..........'),
('...#.#....'),
('...##....#'),
('........#.'),
('.......#..'),
('#.##....#.'),
('##..#..#..'),
('#.#.......'),
('.#..#..##.'),
(''),
('Tile 3643:'),
('.#..#..#..'),
('#.........'),
('...#....#.'),
('......#..#'),
('...#......'),
('#.........'),
('.........#'),
('....#.....'),
('#....#...#'),
('#..#....##'),
(''),
('Tile 2711:'),
('.#..#.#.##'),
('#..#..#..#'),
('.......#.#'),
('#..##....#'),
('#.#.......'),
('#...#.#...'),
('.#.#......'),
('...#......'),
('.#...#...#'),
('#.#..####.'),
(''),
('Tile 2423:'),
('#.#.#.....'),
('...#......'),
('..#......#'),
('..........'),
('##.....#..'),
('###.#.#..#'),
('.......#.#'),
('#..#.#..#.'),
('...#...#..'),
('##.#.#####'),
(''),
('Tile 1663:'),
('..##.....#'),
('#....#...#'),
('.##....#.#'),
('...#..##.#'),
('#...##..#.'),
('####..#...'),
('##........'),
('#........#'),
('#...#.....'),
('######..##'),
(''),
('Tile 1861:'),
('##...#.#..'),
('.........#'),
('......#.##'),
('.....#...#'),
('....#....#'),
('........#.'),
('...#......'),
('..........'),
('..#.......'),
('..######.#'),
(''),
('Tile 3659:'),
('..#.##.###'),
('.#....#...'),
('##.#.#...#'),
('#.##.#..##'),
('.#...###.#'),
('###......#'),
('#.#......#'),
('..#..#...#'),
('#.....#.##'),
('..#.#.....'),
(''),
('Tile 1733:'),
('.....#.###'),
('..#..#...#'),
('#........#'),
('...#..#..#'),
('.#.#...#.#'),
('###.......'),
('#........#'),
('.#.#...#..'),
('#....##..#'),
('...#......'),
(''),
('Tile 3271:'),
('###.####.#'),
('#......#..'),
('.#....#..#'),
('..........'),
('#.#...#.##'),
('......#...'),
('.......##.'),
('#....#....'),
('##....##.#'),
('.....#.##.'),
(''),
('Tile 3761:'),
('..#...##..'),
('.......#.#'),
('...#..#.##'),
('#...#....#'),
('...#......'),
('.........#'),
('#...#.....'),
('.......#..'),
('.#..#.....'),
('##.####.#.'),
(''),
('Tile 3449:'),
('..###.#...'),
('#...#....#'),
('...##....#'),
('#..##..#..'),
('#.#.......'),
('#.........'),
('#..#.#...#'),
('#...#....#'),
('.###.#....'),
('#.....##..'),
(''),
('Tile 2861:'),
('#.#....###'),
('.........#'),
('#.#..#.#.#'),
('#....##...'),
('#........#'),
('#..##.....'),
('#.......##'),
('#....#...#'),
('#........#'),
('##...####.'),
(''),
('Tile 1877:'),
('..#.#.###.'),
('#...##...#'),
('.......##.'),
('#...#...#.'),
('..#.......'),
('#........#'),
('....#.###.'),
('#...#....#'),
('#.........'),
('#.##.#.#.#'),
(''),
('Tile 1091:'),
('###...#.##'),
('..#......#'),
('.#..#.#...'),
('#.......#.'),
('......#..#'),
('....#..#.#'),
('#..#.##.##'),
('..###....#'),
('#.........'),
('.#.###..#.'),
(''),
('Tile 1741:'),
('..####.##.'),
('#.....##..'),
('#....##...'),
('#...##...#'),
('#...##....'),
('#.#..#....'),
('#....#...#'),
('......#...'),
('#.....#..#'),
('##..##.##.'),
(''),
('Tile 2789:'),
('...#.#....'),
('#.......##'),
('#.........'),
('#.#......#'),
('..#..#...#'),
('#......#.#'),
('#...#..#..'),
('#........#'),
('#.....##..'),
('#.###.#.##'),
(''),
('Tile 2017:'),
('#..##...#.'),
('#.#.......'),
('#.........'),
('#......#..'),
('##....#...'),
('.........#'),
('......#..#'),
('#..#.....#'),
('#...#....#'),
('.#.##..#.#'),
(''),
('Tile 2357:'),
('.###....#.'),
('#..#......'),
('.......##.'),
('.....#..##'),
('....#.#.##'),
('...#...#..'),
('#.........'),
('#....#....'),
('........#.'),
('##..###.##'),
(''),
('Tile 3803:'),
('.#.#.#..##'),
('..........'),
('.#.#......'),
('##.#.###..'),
('.#.##..#..'),
('#.###....#'),
('........##'),
('##..#.....'),
('.#.......#'),
('...###...#'),
(''),
('Tile 1223:'),
('.###...#.#'),
('#....#...#'),
('..........'),
('###...#...'),
('#..###....'),
('.#.....#.#'),
('.#.......#'),
('....#....#'),
('.#......#.'),
('.#.#.###..'),
(''),
('Tile 1657:'),
('##.##.#..#'),
('#.......#.'),
('#........#'),
('....##...#'),
('#.#.#..#..'),
('.........#'),
('..#..#...#'),
('..#......#'),
('#.#.......'),
('.###.###.#'),
(''),
('Tile 3187:'),
('##..#....#'),
('#..#......'),
('.........#'),
('#.#...#...'),
('#.........'),
('#....#.#..'),
('#..#.##.#.'),
('.....#.#.#'),
('....##...#'),
('.###....##'),
(''),
('Tile 2341:'),
('###..#....'),
('.......#.#'),
('..........'),
('..#..#..##'),
('.......#..'),
('#.........'),
('#....#.#.#'),
('#........#'),
('##..#....#'),
('...##.#...'),
(''),
('Tile 3461:'),
('#..#.#....'),
('...##....#'),
('#........#'),
('......#.#.'),
('.......#.#'),
('#......#..'),
('.........#'),
('......#...'),
('#..#....##'),
('########..'),
(''),
('Tile 2767:'),
('#..#####.#'),
('..#.##.##.'),
('.##.##..#.'),
('..#.......'),
('#...##.###'),
('.......###'),
('#..#.#....'),
('...#...#.#'),
('...#......'),
('.##......#'),
(''),
('Tile 3137:'),
('##...####.'),
('.#........'),
('.........#'),
('##......##'),
('........##'),
('#...##...#'),
('#......#.#'),
('.#......##'),
('...##...##'),
('...#..#.##'),
(''),
('Tile 3011:'),
('#..##....#'),
('..#.....##'),
('#......##.'),
('.#..###...'),
('.#..#..###'),
('.#.#.##..#'),
('#.#....#.#'),
('........##'),
('#........#'),
('####.##...'),
(''),
('Tile 3677:'),
('#...###.#.'),
('#..#...#.#'),
('##........'),
('..#....#..'),
('#.#.......'),
('...#....#.'),
('#..#..#.##'),
('.##...###.'),
('#.........'),
('#...###.##'),
(''),
('Tile 3559:'),
('#.#..#...#'),
('####....#.'),
('....####.#'),
('..##.#...#'),
('#....##...'),
('#.....#...'),
('#..##.....'),
('##.....#.#'),
('##...#....'),
('.###.##.##'),
(''),
('Tile 1259:'),
('..####.#.#'),
('..##.#..#.'),
('##.#....##'),
('#.#.#...##'),
('#..#.#....'),
('...##.#...'),
('..#.#.....'),
('...#.#....'),
('#####..#.#'),
('..#...###.'),
(''),
('Tile 3019:'),
('#...#.##.#'),
('##.....#.#'),
('#.#...#..#'),
('#.........'),
('#........#'),
('#.........'),
('.....#....'),
('.#.#.....#'),
('.......#..'),
('##.###..#.'),
(''),
('Tile 2377:'),
('##..#.#..#'),
('.....#.#.#'),
('#...#....#'),
('#..#......'),
('..#..#.#.#'),
('...##...##'),
('...#.#..##'),
('....#.#..#'),
('.......###'),
('....##.#.#'),
(''),
('Tile 1889:'),
('.###......'),
('......#..#'),
('.##......#'),
('#.#....#..'),
('#..#.....#'),
('.#.##.....'),
('##.#.....#'),
('..........'),
('#......#.#'),
('###.#.###.'),
(''),
('Tile 2677:'),
('#.#....#..'),
('#.........'),
('#.........'),
('#.........'),
('.........#'),
('....##.#.#'),
('....#..###'),
('#...#..#.#'),
('......#..#'),
('...#.#####'),
(''),
('Tile 3539:'),
('#.##...###'),
('...#...#..'),
('........#.'),
('..#..#..#.'),
('##.....#.#'),
('.#...#....'),
('...#...#.#'),
('##....####'),
('....#...#.'),
('#.##.#.###'),
(''),
('Tile 1283:'),
('.####.#..#'),
('..#.......'),
('##.##....#'),
('##....#...'),
('#.....#..#'),
('.#.......#'),
('..#.#....#'),
('..#.#..#..'),
('.#..#.....'),
('..###..#.#'),
(''),
('Tile 1181:'),
('######.#.#'),
('.##......#'),
('....###...'),
('#...##..##'),
('....#....#'),
('#....#...#'),
('#......#..'),
('#..#.#...#'),
('...#.#...#'),
('.#..##.###'),
(''),
('Tile 1721:'),
('.#.#...##.'),
('#.........'),
('...#.....#'),
('......#...'),
('#..#...###'),
('...#..###.'),
('#..#.#.#..'),
('#.#......#'),
('.#..#....#'),
('##.#.#..#.'),
(''),
('Tile 3533:'),
('##..#.#.##'),
('#........#'),
('#.....##.#'),
('#.....##..'),
('#.........'),
('.........#'),
('#........#'),
('....#..#..'),
('#........#'),
('.#..##.##.'),
(''),
('Tile 1871:'),
('.####.##.#'),
('..#.#.....'),
('...#......'),
('.......#.#'),
('....#....#'),
('#........#'),
('#.......##'),
('#........#'),
('#......#.#'),
('..###...##'),
(''),
('Tile 2239:'),
('...###....'),
('###.#.#.##'),
('###.......'),
('..#....###'),
('..##..#..#'),
('#.#.#.##..'),
('.......#.#'),
('.#.#......'),
('#.##..#..#'),
('#.......#.'),
(''),
('Tile 3491:'),
('####.#...#'),
('#.###...##'),
('#...#.....'),
('...#....##'),
('.#......##'),
('.#......#.'),
('#...#....#'),
('.........#'),
('#....#.###'),
('###..#..##'),
(''),
('Tile 3389:'),
('##.#......'),
('.......#.#'),
('..#.......'),
('#..##.....'),
('#....#..##'),
('#........#'),
('......#...'),
('#.........'),
('..#...#..#'),
('###..###.#'),
(''),
('Tile 1423:'),
('...#.###.#'),
('#.....#...'),
('##........'),
('.....#....'),
('#.#.##..##'),
('##...###..'),
('..........'),
('.##.......'),
('#.#..#....'),
('.##..#..#.'),
(''),
('Tile 2251:'),
('##....###.'),
('#..##....#'),
('...#.....#'),
('#....#...#'),
('.##.#....#'),
('#..##...##'),
('#..###...#'),
('..........'),
('.##...##..'),
('.....#...#'),
(''),
('Tile 2417:'),
('.......##.'),
('#........#'),
('.#........'),
('#..#.....#'),
('#.#..###..'),
('##.......#'),
('#........#'),
('###......#'),
('...#.....#'),
('.#.#.#.#..'),
(''),
('Tile 2113:'),
('.##.#..#.#'),
('#.........'),
('#.#......#'),
('#......#.#'),
('.......#..'),
('#...#.####'),
('#.....##..'),
('.....#..#.'),
('#.........'),
('#.##..#.#.'),
('');
INSERT INTO #Input
VALUES
('Tile 2297:'),
('.#...#..#.'),
('#.........'),
('#...#.....'),
('.......#..'),
('..#.....#.'),
('#.......#.'),
('........#.'),
('.....#....'),
('...##..#..'),
('######.###'),
(''),
('Tile 3631:'),
('#....###.#'),
('.....#...#'),
('.........#'),
('#........#'),
('#..#...#..'),
('#........#'),
('##.#......'),
('..#....#.#'),
('##....#..#'),
('######.#..'),
(''),
('Tile 1277:'),
('.#.#.#.###'),
('#.#.#..#..'),
('##..###...'),
('#....#...#'),
('......#..#'),
('.........#'),
('#..#...#..'),
('##...#....'),
('.........#'),
('...####..#'),
(''),
('Tile 1051:'),
('##.##.#.##'),
('#..##...##'),
('..#.#..#..'),
('....#....#'),
('#.#.....##'),
('..#......#'),
('#.......##'),
('..#......#'),
('##....#..#'),
('.#...#.##.'),
(''),
('Tile 2137:'),
('#.#..#.##.'),
('...##.....'),
('..#.....#.'),
('#......#.#'),
('.........#'),
('#.........'),
('#.......##'),
('#.#......#'),
('......#..#'),
('.#.###.#.#'),
(''),
('Tile 2089:'),
('##.#.###..'),
('.#.#..#..#'),
('#.#..#..#.'),
('...#..#...'),
('#.#..#..##'),
('#..##....#'),
('##.......#'),
('#.#...##.#'),
('#........#'),
('#.##.#....'),
(''),
('Tile 3433:'),
('.##..##...'),
('##.......#'),
('..........'),
('.##..#...#'),
('#..#...#..'),
('#..#....#.'),
('..#...#..#'),
('#........#'),
('.....#....'),
('..##...##.'),
(''),
('Tile 2099:'),
('###.....#.'),
('#..#.##...'),
('#.....#..#'),
('#.#..#.#..'),
('..#....#..'),
('...#....##'),
('#.##.#...#'),
('.#.......#'),
('#..#......'),
('..#.#.#.##'),
(''),
('Tile 2179:'),
('...#.##..#'),
('..#....#.#'),
('#.....#...'),
('....#.....'),
('#...#.#.#.'),
('#.........'),
('...#.#..#.'),
('.......###'),
('........#.'),
('.#.#.##...'),
(''),
('Tile 3229:'),
('.##...#..#'),
('#.......#.'),
('#.#..##..#'),
('.##.......'),
('..........'),
('.#.....#.#'),
('.....#..##'),
('#.#.#...##'),
('#.#.#.#..#'),
('##..#...##'),
(''),
('Tile 1327:'),
('.####..#.#'),
('...#...#.#'),
('........##'),
('....#....#'),
('........#.'),
('#...#..#..'),
('.#.#......'),
('......#..#'),
('.#......##'),
('..##.#....'),
(''),
('Tile 2503:'),
('#..####.##'),
('#...#.....'),
('...#.....#'),
('.#.......#'),
('.........#'),
('##......#.'),
('..#....###'),
('#..#...##.'),
('..........'),
('#.#..#.###'),
(''),
('Tile 2351:'),
('.##..##...'),
('#.#.......'),
('....#.#..#'),
('...#.....#'),
('..#.......'),
('.#.......#'),
('#....##...'),
('...#.....#'),
('#...#.....'),
('#....#.###'),
(''),
('Tile 1019:'),
('...##..#..'),
('..#.#....#'),
('##.#..#..#'),
('.#.....#..'),
('.........#'),
('##.....#.#'),
('......#..#'),
('#.........'),
('....#..#.#'),
('.#...#..##'),
(''),
('Tile 2521:'),
('#...#.#.#.'),
('..#.###..#'),
('#.#...##..'),
('.........#'),
('##........'),
('#..#..#..#'),
('##........'),
('.#........'),
('..#..#....'),
('.#...####.'),
(''),
('Tile 1627:'),
('.#...##.#.'),
('###......#'),
('......#...'),
('.##.......'),
('#......#.#'),
('.......#.#'),
('...#....#.'),
('#.#......#'),
('...#.#....'),
('######..#.'),
(''),
('Tile 2347:'),
('#.##.#.##.'),
('...##.....'),
('.#..#.#.##'),
('.#........'),
('#.....#...'),
('...#....#.'),
('#.........'),
('...#..#...'),
('.###.#.#.#'),
('..###..###'),
(''),
('Tile 3413:'),
('#.##..#...'),
('....#..#..'),
('#....#.###'),
('.#..#....#'),
('..#...#...'),
('#........#'),
('#.....##..'),
('#........#'),
('..#..#...#'),
('.#..#####.'),
(''),
('Tile 2647:'),
('.####.#.#.'),
('#.........'),
('#..#.....#'),
('#....#....'),
('..........'),
('#........#'),
('#..#.#....'),
('#...#....#'),
('......#.##'),
('##.#####.#'),
(''),
('Tile 1039:'),
('##..####.#'),
('#....#.#.#'),
('..#..#...#'),
('#...#.....'),
('..........'),
('#...#..#..'),
('#.......#.'),
('.......#.#'),
('#.#......#'),
('....#.##..'),
(''),
('Tile 2053:'),
('##.##.#...'),
('#.#.......'),
('..###....#'),
('##.#......'),
('#.#..#...#'),
('..####..#.'),
('.#..##.#..'),
('#...#.....'),
('.........#'),
('.....##.#.'),
(''),
('Tile 2909:'),
('#.#######.'),
('##...#...#'),
('..........'),
('##.#.#...#'),
('.#..#.....'),
('###....#..'),
('#.#......#'),
('...####...'),
('##.###....'),
('.#.#.##..#'),
(''),
('Tile 1567:'),
('.....##.##'),
('.....##..#'),
('#.###.....'),
('.......#.#'),
('.###.....#'),
('#..#.....#'),
('###.......'),
('..###....#'),
('#....#...#'),
('....##..##'),
(''),
('Tile 2687:'),
('####...##.'),
('#..#.#...#'),
('#.........'),
('.....#...#'),
('#.........'),
('.......#.#'),
('##..#...##'),
('.....###..'),
('#.....#.#.'),
('#...#.####'),
(''),
('Tile 3121:'),
('#.####...#'),
('###.......'),
('#...##...#'),
('#..#....##'),
('#....#...#'),
('.....#....'),
('...##..#.#'),
('.#........'),
('.#....#.##'),
('#.#...#.##'),
(''),
('Tile 3547:'),
('.##.###...'),
('#.##..#...'),
('#........#'),
('#.##......'),
('#..#.##...'),
('##...#....'),
('.##.#.#.#.'),
('........##'),
('.#.......#'),
('..####..#.'),
(''),
('Tile 1787:'),
('##.###.##.'),
('...#...#.#'),
('##.......#'),
('#..##....#'),
('.#...#.#..'),
('.........#'),
('##.....#..'),
('#.........'),
('#.........'),
('.###.#####'),
(''),
('Tile 1811:'),
('####.##.#.'),
('#..#...##.'),
('.#.......#'),
('........##'),
('#........#'),
('##.#.....#'),
('..#.....#.'),
('.#.....#.#'),
('#.....##.#'),
('.#..#.....'),
(''),
('Tile 2293:'),
('#..##..#..'),
('#...#....#'),
('.........#'),
('...##....#'),
('#......#..'),
('......#..#'),
('#........#'),
('#..#......'),
('#.#.....#.'),
('...##..#..'),
(''),
('Tile 1933:'),
('#.#...####'),
('#......#..'),
('..........'),
('.....#....'),
('#..#.....#'),
('.........#'),
('..#.##...#'),
('.##..##..#'),
('.......#.#'),
('..#..###..'),
(''),
('Tile 2659:'),
('####.##.##'),
('#...#.....'),
('...#.#....'),
('#.........'),
('.#.......#'),
('#..##.#..#'),
('#...##...#'),
('##..#.##..'),
('#.#...#..#'),
('.#.#.#...#'),
(''),
('Tile 2069:'),
('#..#......'),
('#.#......#'),
('###.....#.'),
('....#....#'),
('........##'),
('#....#....'),
('#.#..#....'),
('#....#...#'),
('#....##...'),
('##..###.##'),
(''),
('Tile 2879:'),
('####.####.'),
('#.......#.'),
('.#.#....##'),
('#.##.....#'),
('...#......'),
('#.........'),
('#...##....'),
('......#...'),
('#..#.#.#.#'),
('###..##.##'),
(''),
('Tile 2957:'),
('#.#.####..'),
('#.#..#...#'),
('#.........'),
('#...#....#'),
('#....#.#..'),
('......#..#'),
('.....##..#'),
('#....#.#.#'),
('##.....#..'),
('###.##.#.#'),
(''),
('Tile 2029:'),
('#.#..###.#'),
('.....#..##'),
('...#......'),
('..#..#..##'),
('.#...##...'),
('...#....##'),
('####..#...'),
('..#....#..'),
('.........#'),
('.#####.###'),
(''),
('Tile 1607:'),
('##.##.#...'),
('......#..#'),
('.........#'),
('..#...#.##'),
('...#......'),
('##........'),
('...#.....#'),
('#...#..#..'),
('#......#.#'),
('#....###..'),
(''),
('Tile 3943:'),
('.##.####.#'),
('#..#..#...'),
('#.....#..#'),
('###.#....#'),
('..###...##'),
('#.......##'),
('#..##.....'),
('.....##.#.'),
('....#..#..'),
('.###.#...#'),
(''),
('Tile 3593:'),
('..#.#.#.#.'),
('##......##'),
('.##......#'),
('....#....#'),
('....#...##'),
('#...#....#'),
('..........'),
('#......##.'),
('#......##.'),
('#..#...#..'),
(''),
('Tile 1583:'),
('##...#..##'),
('#..#.....#'),
('.#.......#'),
('#.....#.#.'),
('##.....#..'),
('##........'),
('..........'),
('...#..#...'),
('#...#.....'),
('.##.......'),
(''),
('Tile 3709:'),
('#..#...###'),
('##..##...#'),
('..##....##'),
('#.....#..#'),
('##..#.#..#'),
('#......#.#'),
('#.#.......'),
('.....#...#'),
('#.......#.'),
('..#..###..'),
(''),
('Tile 1667:'),
('..##......'),
('##........'),
('..##.#...#'),
('#......###'),
('.......##.'),
('........##'),
('.###.....#'),
('#.#.#...##'),
('......#..#'),
('#..#.####.'),
(''),
('Tile 3851:'),
('###.#.#...'),
('..#......#'),
('....#.....'),
('.........#'),
('##.###...#'),
('#........#'),
('...##..#.#'),
('..##......'),
('..........'),
('..#..####.'),
(''),
('Tile 3083:'),
('..#.#...##'),
('#...#.....'),
('##.....#..'),
('#.#......#'),
('..##......'),
('###.#.#..#'),
('#.........'),
('#.........'),
('###......#'),
('..#..###.#'),
(''),
('Tile 2927:'),
('#.##.####.'),
('#.........'),
('#.....###.'),
('#.#..#...#'),
('..#......#'),
('.#........'),
('..........'),
('#..#......'),
('........#.'),
('.....#####'),
(''),
('Tile 2837:'),
('#.###.#..#'),
('#.##....##'),
('#..#..#..#'),
('.........#'),
('....#.....'),
('.#.#......'),
('#..####..#'),
('.##.......'),
('.#...#..##'),
('####.#####'),
(''),
('Tile 1499:'),
('..#.##....'),
('##.#......'),
('#.#####..#'),
('....#..##.'),
('..#..#...#'),
('..#.#.....'),
('##.......#'),
('#........#'),
('#..#.#....'),
('....###...'),
(''),
('Tile 2857:'),
('.#...#...#'),
('.....##...'),
('.........#'),
('..#.......'),
('#........#'),
('#...#.....'),
('..........'),
('#........#'),
('#....#....'),
('.###...#..'),
(''),
('Tile 1237:'),
('..#######.'),
('#.....###.'),
('#.#...#...'),
('#.#.......'),
('###......#'),
('..#...#..#'),
('..........'),
('........##'),
('.#.#...#.#'),
('.#....###.'),
(''),
('Tile 3221:'),
('.####.####'),
('........##'),
('.....#....'),
('..........'),
('..#...#..#'),
('..##.#.###'),
('#..##.....'),
('##.#.#...#'),
('........##'),
('##.#.#.#..'),
(''),
('Tile 2531:'),
('....###.#.'),
('#...##...#'),
('#...##....'),
('#...#....#'),
('#.....#...'),
('..#..#..#.'),
('.#.###..#.'),
('#.....#..#'),
('#.......#.'),
('#.###..###'),
(''),
('Tile 2689:'),
('#.#.#..#.#'),
('.......##.'),
('#.#..#..#.'),
('#........#'),
('#.##......'),
('##.......#'),
('##......##'),
('........#.'),
('..#..#..##'),
('###.#.####'),
(''),
('Tile 2953:'),
('##.##..#..'),
('#....#...#'),
('...#.....#'),
('#...#.....'),
('...#.....#'),
('.##.##..##'),
('...##....#'),
('......#..#'),
('#.....#.##'),
('.#.##...#.'),
(''),
('Tile 3191:'),
('.#.#....#.'),
('#..#.#...#'),
('#...#....#'),
('###.#.#.#.'),
('.##.......'),
('#..#......'),
('.#.#......'),
('#.##.#...#'),
('..........'),
('.#..#.#.#.'),
(''),
('Tile 2797:'),
('#....#####'),
('.........#'),
('.#.....#.#'),
('....#.....'),
('.......#.#'),
('..........'),
('#....##...'),
('.#...#..#.'),
('.........#'),
('#.###.##.#'),
(''),
('Tile 3767:'),
('.#..###..#'),
('...##.#..#'),
('.##....#.#'),
('.....#...#'),
('...#....##'),
('..........'),
('#..#.#...#'),
('#.........'),
('##........'),
('#..##...#.'),
(''),
('Tile 2207:'),
('.#.##.#...'),
('#....#....'),
('..........'),
('#.........'),
('....#.....'),
('#........#'),
('#...#.....'),
('#.........'),
('.....##...'),
('#..#...##.'),
(''),
('Tile 1171:'),
('##.##...##'),
('.........#'),
('..........'),
('#.##......'),
('.........#'),
('#........#'),
('...#..#...'),
('..#.......'),
('..........'),
('....#..#..'),
(''),
('Tile 2267:'),
('#.####..##'),
('#..#.....#'),
('#.....#..#'),
('...#......'),
('..##.#.#.#'),
('..#...#..#'),
('.#..#.....'),
('..#......#'),
('.....#.#..'),
('.#........'),
(''),
('Tile 2213:'),
('##.#####.#'),
('.......###'),
('.....#...#'),
('#......#..'),
('......#..#'),
('..#.......'),
('.....##..#'),
('..##....##'),
('..#.......'),
('#..##....#'),
(''),
('Tile 2011:'),
('#..##..###'),
('#.......##'),
('.#......##'),
('#.#..#.#.#'),
('#.....#..#'),
('..##.#.##.'),
('.#.###.#.#'),
('.......#.#'),
('........#.'),
('###..##.##'),
(''),
('Tile 3877:'),
('..#..#.#.#'),
('.......#.#'),
('.......#.#'),
('##........'),
('........##'),
('#.##.#...#'),
('..##.##..#'),
('###.#..###'),
('........#.'),
('#.##.#..#.'),
(''),
('Tile 1427:'),
('.#.....#.#'),
('#..###.##.'),
('#.###...#.'),
('#..#.....#'),
('.#...#.##.'),
('#.#..#..#.'),
('...##.####'),
('.......#.#'),
('##.##....#'),
('.#.###....'),
(''),
('Tile 1021:'),
('.##.###...'),
('.##.#....#'),
('#......#..'),
('#..#.....#'),
('#....#..##'),
('#....###..'),
('#......#.#'),
('.........#'),
('#..#.....#'),
('.#........'),
(''),
('Tile 1523:'),
('##..##.#.#'),
('#.#..#.#.#'),
('#..#...#.#'),
('#.##..#...'),
('#...#....#'),
('#......#.#'),
('..#.###...'),
('.....#..##'),
('..........'),
('#####..#.#'),
(''),
('Tile 1319:'),
('##..######'),
('#....#...#'),
('##........'),
('#.......#.'),
('#.#.....#.'),
('#..#...#.#'),
('#...#....#'),
('....######'),
('...#.....#'),
('..####.###'),
(''),
('Tile 1543:'),
('..##....#.'),
('#.........'),
('#.........'),
('.........#'),
('#.........'),
('#.........'),
('....#.#..#'),
('#.........'),
('.#..##...#'),
('####..#.#.'),
(''),
('Tile 1697:'),
('...#....#.'),
('#......#..'),
('......#..#'),
('...#......'),
('.#.#...#.#'),
('.##.......'),
('###......#'),
('.........#'),
('##.###.##.'),
('.##.#.....'),
(''),
('Tile 3391:'),
('.##.#.####'),
('##..#....#'),
('#..##....#'),
('#..#..#...'),
('#.........'),
('##...##.##'),
('..........'),
('.........#'),
('.......#..'),
('#.#####.#.'),
(''),
('Tile 2833:'),
('.#.#...###'),
('......#..#'),
('#..####..#'),
('.........#'),
('....#....#'),
('#...#...#.'),
('##....#.##'),
('#...###..#'),
('#..#......'),
('...#.#..##');

CREATE TABLE #TileEdges (
	GroupNumber INT,
	TileNumber INT,
	TileLine NVARCHAR(MAX),
	Orientation INT
);

-- Get answers grouped together and assigned a group number
SELECT		(SELECT COUNT(*) + 1 FROM #Input IC WHERE IC.InputRowId <= I.InputRowId AND IC.TileLine = '') AS GroupNumber,
			InputRowId,
			TileLine
INTO		#TileGroups
FROM		#Input I
WHERE		TileLine != ''

-- Table containing tile data
SELECT		TG.GroupNumber,
			(
				SELECT		CAST(SUBSTRING(TGA.TileLine, 5, LEN(TGA.TileLine) - 5) AS INT)
				FROM		#TileGroups TGA
				INNER JOIN	(
					SELECT		Min(TGB.InputRowId) AS MinInputRowId
					FROM		#TileGroups TGB
					WHERE		TGB.GroupNumber = TG.GroupNumber
				) AS TGC ON TGA.InputRowId = MinInputRowId
			) AS TileNumber,
			(
					SELECT		MIN(TGB.InputRowId) + 1 AS MinInputRowId
					FROM		#TileGroups TGB
					WHERE		TGB.GroupNumber = TG.GroupNumber
			) AS MinInputRowId,
			(
				SELECT		TGA.TileLine
				FROM		#TileGroups TGA
				INNER JOIN	(
					SELECT		Min(TGB.InputRowId) + 1 AS MinInputRowId
					FROM		#TileGroups TGB
					WHERE		TGB.GroupNumber = TG.GroupNumber
				) AS TGC ON TGA.InputRowId = MinInputRowId
			) AS TopRow,
			(
					SELECT		MAX(TGB.InputRowId) AS MaxInputRowId
					FROM		#TileGroups TGB
					WHERE		TGB.GroupNumber = TG.GroupNumber
			) AS MaxInputRowId,
			(
				SELECT		TGA.TileLine
				FROM		#TileGroups TGA
				INNER JOIN	(
					SELECT		MAX(TGB.InputRowId) AS MaxInputRowId
					FROM		#TileGroups TGB
					WHERE		TGB.GroupNumber = TG.GroupNumber
				) AS TGC ON TGA.InputRowId = MaxInputRowId
			) AS BottomRow
INTO		#TileData
FROM		#TileGroups TG
GROUP BY	TG.GroupNumber

INSERT INTO #TileEdges
SELECT		GroupNumber,
			TileNumber,
			TopRow,
			1
FROM		#TileData

INSERT INTO #TileEdges
SELECT		GroupNumber,
			TileNumber,
			BottomRow,
			-3
FROM		#TileData

INSERT INTO #TileEdges
SELECT		TD.GroupNumber,
			TD.TileNumber,
			SUBSTRING(STRING_AGG(SUBSTRING(TG.TileLine, 1,1), '') WITHIN GROUP(ORDER BY TG.InputRowId), 2, 10000) AS TileLine,
			-2
FROM		#TileData TD
INNER JOIN	#TileGroups TG
			ON TG.GroupNumber = TD.GroupNumber
GROUP BY	TD.GroupNumber,
			TD.TIleNumber

INSERT INTO #TileEdges
SELECT		TD.GroupNumber,
			TD.TileNumber,
			SUBSTRING(STRING_AGG(SUBSTRING(TG.TileLine, LEN(TG.TileLine),1), '') WITHIN GROUP(ORDER BY TG.InputRowId), 2, 10000) AS TileLine,
			4
FROM		#TileData TD
INNER JOIN	#TileGroups TG
			ON TG.GroupNumber = TD.GroupNumber
GROUP BY	TD.GroupNumber,
			TD.TIleNumber

-- Reverse tiles
INSERT INTO	#TileEdges
SELECT		GroupNumber,
			TileNumber,
			REVERSE(TileLine) AS TileLine,
			Orientation * -1
FROM		#TileEdges;

SELECT			TE.GroupNumber AS SourceGroupNumber,
				TE.TileNumber AS SourceTileNumber,
				TE.Orientation AS SourceOrientation,
				TE2.GroupNumber AS TargetGroupNumber,
				TE2.TileNumber AS TargetTileNumber,
				TE2.Orientation AS TargetOrientation
INTO			#AdjacentTiles
FROM			#TileEdges TE
INNER JOIN		#TileEdges TE2 ON TE.TileLine = TE2.TileLine AND TE.GroupNumber != TE2.GroupNumber;


IF OBJECT_ID('tempdb.dbo.#PermittedArrangements', 'U') IS NOT NULL
BEGIN
	DROP TABLE #PermittedArrangements
END

CREATE TABLE #PermittedArrangements
(
	TopEdge INT,
	Edge INT,
	EdgeName nvarchar(30)
)

INSERT INTO #PermittedArrangements (TopEdge, Edge, EdgeName)
VALUES
(1, 1, 'T'),
(1, 2, 'L'),
(1, 3, 'B'),
(1, 4, 'R'),
(1, -1, '-T'),
(1, -2, '-L'),
(1, -3, '-B'),
(1, -4, '-R'),

(2, 2, 'T'),
(2, 3, 'L'),
(2, 4, 'B'),
(2, 1, 'R'),
(2, -2, '-T'),
(2, -3, '-L'),
(2, -4, '-B'),
(2, -1, '-R'),

(3, 3, 'T'),
(3, 4, 'L'),
(3, 1, 'B'),
(3, 2, 'R'),
(3, -3, '-T'),
(3, -4, '-L'),
(3, -1, '-B'),
(3, -2, '-R'),

(4, 4, 'T'),
(4, 1, 'L'),
(4, 2, 'B'),
(4, 3, 'R'),
(4, -4, '-T'),
(4, -1, '-L'),
(4, -2, '-B'),
(4, -3, '-R'),

(-1, -1, 'T'),
(-1, -4, 'L'),
(-1, -3, 'B'),
(-1, -2, 'R'),
(-1, 1, '-T'),
(-1, 4, '-L'),
(-1, 3, '-B'),
(-1, 2, '-R'),

(-2, -2, 'T'),
(-2, -1, 'L'),
(-2, -4, 'B'),
(-2, -3, 'R'),
(-2, 2, '-T'),
(-2, 1, '-L'),
(-2, 4, '-B'),
(-2, 3, '-R'),

(-3, -3, 'T'),
(-3, -2, 'L'),
(-3, -1, 'B'),
(-3, -4, 'R'),
(-3, 3, '-T'),
(-3, 2, '-L'),
(-3, 1, '-B'),
(-3, 4, '-R'),

(-4, -4, 'T'),
(-4, -3, 'L'),
(-4, -2, 'B'),
(-4, -1, 'R'),
(-4, 4, '-T'),
(-4, 3, '-L'),
(-4, 2, '-B'),
(-4, 1, '-R');

IF OBJECT_ID('tempdb.dbo.#AssociatedEdges', 'U') IS NOT NULL
BEGIN
	DROP TABLE #AssociatedEdges
END

CREATE TABLE #AssociatedEdges(
	EdgeName nvarchar(4),
	AssociatedEdgeName nvarchar(4)
)

INSERT INTO #AssociatedEdges (EdgeName, AssociatedEdgeName)
VALUES
('T', 'B'),
('-T', '-B'),
('L', 'R'),
('-L', '-R'),
('B', 'T'),
('-B', '-T'),
('R', 'L'),
('-R', '-L');

IF OBJECT_ID('tempdb.dbo.#OrientedImage', 'U') IS NOT NULL
BEGIN
	DROP TABLE #OrientedImage
END

CREATE TABLE #OrientedImage (
	GroupNumber int,
	TileNumber int,
	X int,
	Y int,
	TopEdge int
);

WITH CornerCount_CTE AS
(
SELECT		SourceGroupNumber,
			SourceTileNumber,
			COUNT(*) AS C
FROM		#AdjacentTiles
GROUP BY	SourceGroupNumber,
			SourceTileNumber
)
INSERT INTO	#OrientedImage (GroupNumber, TileNumber, X, Y, TopEdge)
--SELECT		TOP 1 SourceGroupNumber, SourceTileNumber, 0, 0, 1
SELECT		TOP 1 69, 2239, 0, 0, 1 -- TODO [DR] - TEMP!
FROM		CornerCount_CTE
WHERE		C = 4

DECLARE @TargetCount int;

SELECT		@TargetCount = MAX(SourceGroupNumber)
FROM		#AdjacentTiles

WHILE (SELECT COUNT(*) FROM #OrientedImage) < @TargetCount
BEGIN
	INSERT INTO #OrientedImage (GroupNumber, TileNumber, X, Y, TopEdge)
	SELECT		DISTINCT
				TargetGroupNumber AS GroupNumber,
				TargetTileNumber AS TileNumber,
				CASE
					WHEN PA.EdgeName IN ('L', '-L')
					THEN X-1
					WHEN PA.EdgeName IN ('R', '-R')
					THEN X+1
					ELSE X
				END AS X,
				CASE
					WHEN PA.EdgeName IN ('T', '-T')
					THEN Y+1
					WHEN PA.EdgeName IN ('B', '-B')
					THEN Y-1
					ELSE Y
				END AS Y,
				PA2.TopEdge AS TopEdge
	FROM		#AdjacentTiles AdT
	INNER JOIN	#OrientedImage OI ON OI.GroupNumber = AdT.SourceGroupNumber
	INNER JOIN	#PermittedArrangements PA ON PA.TopEdge = OI.TopEdge AND PA.Edge = AdT.SourceOrientation
	INNER JOIN	#AssociatedEdges AE ON AE.EdgeName = PA.EdgeName
	INNER JOIN	#PermittedArrangements PA2 ON PA2.Edge = -AdT.TargetOrientation AND PA2.EdgeName = AE.AssociatedEdgeName
	WHERE		SIGN(AdT.SourceOrientation) = SIGN(OI.TopEdge)
	AND NOT EXISTS (
		SELECT	TOP 1 *
		FROM	#OrientedImage OI2
		WHERE	OI2.GroupNumber = AdT.TargetGroupNumber
	)
END

-- Confirmed correct
--SELECT		*
--FROM		#OrientedImage
--ORDER BY	X, Y

IF OBJECT_ID('tempdb.dbo.#TileValues', 'U') IS NOT NULL
BEGIN
	DROP TABLE #TileValues
END

DECLARE @GridSize int = 10;

--WITH TempTest_CTE AS
--(
--	SELECT		GroupNumber,
--				InputRowId - 1 - ((GroupNumber - 1) * (@GridSize + 2)) AS RowId,
--				REPLACE(REPLACE(TileLine, '#', ' #'), '.', ' .') as SpacedTileLine
--	FROM		#TileGroups
--)
--SELECT		GroupNumber,
--			RowId,
--			value as TileValue,
--			ROW_NUMBER() OVER (PARTITION BY GroupNumber, RowId ORDER BY (SELECT 0)) AS ColumnId
--INTO		#TileValues
--FROM		TempTest_CTE
--CROSS APPLY	STRING_SPLIT(SpacedTileLine, ' ')
--WHERE		value = '.' OR value = '#'
--ORDER BY	GroupNumber, RowId;

CREATE TABLE #TileValues
(
	GroupNumber int,
	RowId int,
	ColumnId int,
	TileValue nvarchar(4)
)

DECLARE @CurrentIndex int = 1;
WHILE (@CurrentIndex <= @GridSize)
BEGIN
	INSERT INTO		#TileValues (GroupNumber, RowId, ColumnId, TileValue)
	SELECT			GroupNumber,
					InputRowId - 1 - ((GroupNumber - 1) * (@GridSize + 2)) AS RowId,
					@CurrentIndex AS ColumnId,
					SUBSTRING(TileLine, @CurrentIndex, 1) AS TileValue
	FROM			#TileGroups
	WHERE			LEN(TileLine) = @GridSize

	SET @CurrentIndex = @CurrentIndex + 1;
END

-- Confirmed consistent
--SELECT		*
--FROM		#TileGroups
--ORDER BY	GroupNumber, InputRowId

SELECT		*
FROM		#TileValues
WHERE		GroupNumber = 1
ORDER BY	GroupNumber, RowId, ColumnId


IF OBJECT_ID('tempdb.dbo.#RotatedTileValues', 'U') IS NOT NULL
BEGIN
	DROP TABLE #RotatedTileValues
END

CREATE TABLE #RotatedTileValues
(
	GroupNumber INT,
	TopEdge INT,
	RowID INT,
	ColumnID INT,
	TileValue varchar(1)
);

INSERT INTO	#RotatedTileValues (GroupNumber, TopEdge, RowID, ColumnID, TileValue)
SELECT		GroupNumber,
			1,
			@GridSize + 1 - RowID,
			ColumnID,
			TileValue
FROM		#TileValues;

INSERT INTO	#RotatedTileValues (GroupNumber, TopEdge, RowID, ColumnID, TileValue)
SELECT		GroupNumber,
			2,
			@GridSize + 1 - ColumnID,
			@GridSize + 1 - RowId,
			TileValue
FROM		#TileValues;

INSERT INTO	#RotatedTileValues (GroupNumber, TopEdge, RowID, ColumnID, TileValue)
SELECT		GroupNumber,
			3,
			RowID,
			@GridSize + 1 - ColumnID,
			TileValue
FROM		#TileValues;

INSERT INTO	#RotatedTileValues (GroupNumber, TopEdge, RowID, ColumnID, TileValue)
SELECT		GroupNumber,
			4,
			ColumnID,
			RowId,
			TileValue
FROM		#TileValues;

INSERT INTO	#RotatedTileValues (GroupNumber, TopEdge, RowID, ColumnID, TileValue)
SELECT		GroupNumber,
			-1,
			@GridSize + 1 - RowID,
			@GridSize + 1 - ColumnID,
			TileValue
FROM		#TileValues;

INSERT INTO	#RotatedTileValues (GroupNumber, TopEdge, RowID, ColumnID, TileValue)
SELECT		GroupNumber,
			-2,
			@GridSize + 1 - ColumnID,
			RowId,
			TileValue
FROM		#TileValues;

INSERT INTO	#RotatedTileValues (GroupNumber, TopEdge, RowID, ColumnID, TileValue)
SELECT		GroupNumber,
			-3,
			RowID,
			ColumnID,
			TileValue
FROM		#TileValues;

INSERT INTO	#RotatedTileValues (GroupNumber, TopEdge, RowID, ColumnID, TileValue)
SELECT		GroupNumber,
			-4,
			ColumnID,
			@GridSize + 1 - RowId,
			TileValue
FROM		#TileValues;

IF OBJECT_ID('tempdb.dbo.#SinglePicture', 'U') IS NOT NULL
BEGIN
	DROP TABLE #SinglePicture;
END;

WITH OrderedRows_CTE AS
(
	SELECT		OI.GroupNumber,
				OI.TileNumber,
				(Y * @GridSize) + RowId As RowId,
				(X * @GridSize) + ColumnId As ColumnId,
				TileValue
	FROM		#OrientedImage OI
	INNER JOIN	#RotatedTileValues TV ON OI.GroupNumber = TV.GroupNumber AND OI.TopEdge = TV.TopEdge
)
SELECT		*
INTO		#SinglePicture
FROM		OrderedRows_CTE
ORDER BY	RowId, ColumnId

--SELECT		*
--FROM		#SinglePicture
--WHERE		RowId = 24
--ORDER BY	RowId, ColumnId


DECLARE @MaxRowId INT,
		@MinRowId INT,
		@MaxColId INT,
		@MinColId INT

SELECT		@MaxRowId = MAX(RowId),
			@MinRowId = MIN(RowId),
			@MaxColId = MAX(ColumnID),
			@MinColId = MIN(ColumnId)
FROM		#SinglePicture

DELETE
FROM		#SinglePicture
WHERE		(
				((RowId % @GridSize) + @GridSize) % @GridSize = 0
				--AND			RowId < @MaxRowId
				--AND			RowId > @MinRowId
			)
			OR
			(
				((RowId % @GridSize) + @GridSize) % @GridSize = 1
				--AND			RowId - 1 < @MaxRowId
				--AND			RowId - 1 > @MinRowId
			)
			OR
			(
				((ColumnId % @GridSize) + @GridSize) % @GridSize = 0
				--AND			ColumnId < @MaxColId
				--AND			ColumnId > @MinColId
			)
			OR
			(
				((ColumnId % @GridSize) + @GridSize) % @GridSize = 1
				--AND			ColumnId - 1 < @MaxColId
				--AND			ColumnId - 1 > @MinColId
			)

IF OBJECT_ID('tempdb.dbo.#SinglePictureRenumbered', 'U') IS NOT NULL
BEGIN
	DROP TABLE #SinglePictureRenumbered
END

SELECT		GroupNumber,
			TileNumber,
			RowId = ROW_NUMBER() OVER (PARTITION BY ColumnId ORDER BY RowID),
			ColumnId = ROW_NUMBER() OVER (PARTITION BY RowId ORDER BY ColumnId),
			TileValue
INTO		#SinglePictureRenumbered
FROM		#SinglePicture

--SELECT		*
--FROM		#SinglePictureRenumbered
--WHERE		RowId = 24

DECLARE @TotalHashes int,
		@SeaMonsters int

SELECT		@TotalHashes = COUNT(*)
FROM		#SinglePictureRenumbered
WHERE		TileValue = '#'

SELECT		@SeaMonsters = COUNT(*)
FROM		#SinglePictureRenumbered SPR
WHERE		(
				-- 1
				SELECT		COUNT(*)
				FROM		#SinglePictureRenumbered SPR2
				WHERE		TileValue = '#'
				AND			(
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId + 1) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId + 4) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 5) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 6) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId + 7) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId + 10) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 11) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 12) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId + 13) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId + 16) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 17) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 18) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId + 18) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 19)
							)
			) = 15
OR			(
				-- 2
				SELECT		COUNT(*)
				FROM		#SinglePictureRenumbered SPR2
				WHERE		TileValue = '#'
				AND			(
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId + 1) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId + 4) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 5) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 6) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId + 7) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId + 10) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 11) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 12) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId + 13) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId + 16) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 17) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 18) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId + 18) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 19)
							)
			) = 15
OR		(
				-- 3
				SELECT		COUNT(*)
				FROM		#SinglePictureRenumbered SPR2
				WHERE		TileValue = '#'
				AND			(
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId - 1) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId - 4) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 5) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 6) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId - 7) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId - 10) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 11) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 12) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId - 13) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId - 16) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 17) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 18) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId - 18) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 19)
							)
			) = 15
OR			(
				-- 4
				SELECT		COUNT(*)
				FROM		#SinglePictureRenumbered SPR2
				WHERE		TileValue = '#'
				AND			(
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId - 1) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId - 4) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 5) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 6) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId - 7) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId - 10) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 11) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 12) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId - 13) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId - 16) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 17) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 18) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId - 18) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 19)
							)
			) = 15
OR		(
				-- -1
				SELECT		COUNT(*)
				FROM		#SinglePictureRenumbered SPR2
				WHERE		TileValue = '#'
				AND			(
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId - 1) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId - 4) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 5) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 6) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId - 7) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId - 10) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 11) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 12) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId - 13) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId - 16) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 17) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 18) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId - 18) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId - 19)
							)
			) = 15
OR			(
				-- -2
				SELECT		COUNT(*)
				FROM		#SinglePictureRenumbered SPR2
				WHERE		TileValue = '#'
				AND			(
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId + 1) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId + 4) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 5) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 6) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId + 7) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId + 10) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 11) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 12) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId + 13) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId + 16) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 17) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 18) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId + 18) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId + 19)
							)
			) = 15
OR		(
				-- -3
				SELECT		COUNT(*)
				FROM		#SinglePictureRenumbered SPR2
				WHERE		TileValue = '#'
				AND			(
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId + 1) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId + 4) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 5) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 6) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId + 7) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId + 10) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 11) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 12) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId + 13) OR
								(SPR2.RowId = SPR.RowId + 1 AND SPR2.ColumnId = SPR.ColumnId + 16) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 17) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 18) OR
								(SPR2.RowId = SPR.RowId - 1 AND SPR2.ColumnId = SPR.ColumnId + 18) OR
								(SPR2.RowId = SPR.RowId AND SPR2.ColumnId = SPR.ColumnId + 19)
							)
			) = 15
OR			(
				-- -4
				SELECT		COUNT(*)
				FROM		#SinglePictureRenumbered SPR2
				WHERE		TileValue = '#'
				AND			(
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId - 1) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId - 4) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 5) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 6) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId - 7) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId - 10) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 11) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 12) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId - 13) OR
								(SPR2.ColumnId = SPR.ColumnId - 1 AND SPR2.RowId = SPR.RowId - 16) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 17) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 18) OR
								(SPR2.ColumnId = SPR.ColumnId + 1 AND SPR2.RowId = SPR.RowId - 18) OR
								(SPR2.ColumnId = SPR.ColumnId AND SPR2.RowId = SPR.RowId - 19)
							)
			) = 15

SELECT @TotalHashes - (@SeaMonsters * 15)

SELECT	@SeaMonsters AS SeaMonsters,
		@TotalHashes AS TotalHashes

SELECT	COUNT(*)
FROM	#SinglePictureRenumbered
